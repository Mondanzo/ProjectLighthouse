@using System.Web
@using System.IO
@using LBPUnion.ProjectLighthouse.PlayerData.Profiles
<div id="comments">
    <div class="divider-solid no-margin"></div>
    <h2>Comments</h2>
    @if (Model.Comments.Count == 0 && Model.CommentsEnabled)
    {
        <p>There are no comments.</p>
    }
    else if (!Model.CommentsEnabled)
    {
        <b>
            <i>Comments are disabled.</i>
        </b>
    }
    else
    {
        int count = Model.Comments.Count;
        <p>There @(count == 1 ? "is" : "are") @count comment@(count == 1 ? "" : "s").</p>
    }

    @if (Model.CommentsEnabled && Model.User != null)
    {
        <form class="" action="@Url.RouteUrl(ViewContext.RouteData.Values)/postComment" method="post">
            <div class="field">
                <textarea name="msg"></textarea>
            </div>
            <input type="submit" class="bg-green button">
        </form>
        @if (Model.Comments.Count > 0)
        {
            <div class="divider-dashed no-margin" style="margin-top: 24px"></div>
        }
    }

    @for(int i = 0; i < Model.Comments.Count; i++)
    {
        Comment comment = Model.Comments[i];
        DateTimeOffset timestamp = DateTimeOffset.FromUnixTimeSeconds(comment.Timestamp / 1000);
        StringWriter messageWriter = new();
        HttpUtility.HtmlDecode(comment.getComment(), messageWriter);

        string decodedMessage = messageWriter.ToString();
        string? url = Url.RouteUrl(ViewContext.RouteData.Values);
        if (url == null) continue;

        int rating = comment.ThumbsUp - comment.ThumbsDown;

        <div style="display: flex; margin: 16px 0" id="@comment.CommentId">
            @{
                string style = "";
                if (Model.User?.UserId == comment.PosterUserId)
                {
                    style = "pointer-events: none";
                }
            }
            <div class="voting" style="@(style)">
                <a href="@url/rateComment?commentId=@(comment.CommentId)&rating=@(comment.YourThumb == 1 ? 0 : 1)">
                    <i class="@(comment.YourThumb == 1 ? "bxs-upvote orange" : "bx-upvote") bx " style="display: block"></i>
                </a>
                <span style="text-align: center; margin: auto; @(rating < 0 ? "margin-left: -5px" : "")">@(rating)</span>
                <a href="@url/rateComment?commentId=@(comment.CommentId)&rating=@(comment.YourThumb == -1 ? 0 : -1)">
                            <i class="@(comment.YourThumb == -1 ? "bxs-downvote orange" : "bx-downvote") bx" style="display: block"></i>
                </a>
            </div>

            <div class="comment">
                <a style="font-size: 1.2em; font-family: helium, sans-serif;" href="/user/@comment.PosterUserId">@comment.Poster.Username</a><br>
                @if (comment.Deleted)
                {
                    <i>
                        <span>@decodedMessage</span>
                    </i>
                }
                else
                {
                    <span>@decodedMessage</span>
                }
                <div class="divider-dashed no-margin"></div>
                <p>
                    <i>@timestamp.ToString("MM/dd/yyyy @ h:mm tt") UTC</i>
                </p>
            </div>
        </div>
    }
</div>